platform :android do
  # Get version from pubspec.yaml
  private_lane :get_flutter_version do
    version_line = File.read("../../pubspec.yaml").match(/^version:\s*(.*)$/)[1]
    version_name, build_number = version_line.split("+")
    {
      version_name: version_name.strip,
      build_number: build_number.strip.to_i
    }
  end

  desc "ðŸš€ Release to Firebase (dynamic flavor)"
  lane :release_to_firebase do |options|
    flavor = options[:flavor] || "develop"
    app_id = {
      "develop" => "1:882332676920:android:7c94bf6909b62ccb9247cd",
      "staging" => "1:882332676920:android:d3ef2264fdeb655e9247cd",
      "production" => "1:882332676920:android:3f65c20ad9b725b99247cd"
    }[flavor]

    # Get version from pubspec.yaml
    version_info = get_flutter_version
    version_code = version_info[:build_number]
    version_name = version_info[:version_name]

    # Ask for release note
    release_notes = prompt(
      text: "ðŸ“‹ Enter release notes (type END on a new line to finish):",
      multi_line_end_keyword: "END"
    )

    # Build APK
    sh("flutter build apk --release --flavor #{flavor} --dart-define-from-file=.env/.env.#{flavor}")

    # Distribute to Firebase
    firebase_app_distribution(
      app: app_id,
      groups: "chammy-test",
      release_notes: "ðŸš€ v#{version_name} (Build #{version_code})\n\n#{release_notes}",
      apk_path: "../build/app/outputs/flutter-apk/app-#{flavor}-release.apk"
    )

    UI.success "âœ… Build and upload for #{flavor} done!"
  end
end
